# é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®å’Œé™„ä»¶å›¾ç‰‡ä¸‹è½½æƒé™æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

**æµ‹è¯•æ—¶é—´**: 2025å¹´7æœˆ29æ—¥  
**æµ‹è¯•ç›®çš„**: éªŒè¯é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®è¯»å–å’Œé™„ä»¶å›¾ç‰‡ä¸‹è½½æƒé™  
**æµ‹è¯•åº”ç”¨é…ç½®**:
- App ID: `cli_a8fa1d87c3fad00d`
- App Token: `J4dFbm5S9azofMsW702cSOVwnsh`
- Table ID: `tblwdwrZMikMRyxq`
- App Secret: `CDfRPlOw8VRQrPyLnpzNvd5wBmu6wROp`

## âœ… æµ‹è¯•ç»“æœæ€»ç»“

### ğŸ¯ **å®Œå…¨æˆåŠŸçš„åŠŸèƒ½**

1. **é£ä¹¦APIè®¤è¯** âœ…
   - æˆåŠŸè·å–è®¿é—®ä»¤ç‰Œ (tenant_access_token)
   - ä»¤ç‰Œæœ‰æ•ˆæœŸ: 7200ç§’ (2å°æ—¶)
   - è®¤è¯æ–¹å¼: Internal App è®¤è¯

2. **è¡¨æ ¼æ•°æ®è¯»å–** âœ…
   - æˆåŠŸè·å–è¡¨æ ¼å­—æ®µä¿¡æ¯: **47ä¸ªå­—æ®µ**
   - æˆåŠŸè·å–è¡¨æ ¼è®°å½•æ•°æ®: **1244æ¡è®°å½•** (æµ‹è¯•äº†å‰20æ¡)
   - æ•°æ®ç±»å‹æ”¯æŒ: æ–‡æœ¬ã€æ•°å­—ã€é€‰æ‹©ã€é™„ä»¶ç­‰å¤šç§ç±»å‹

3. **å›¾ç‰‡æ–‡ä»¶è¯†åˆ«** âœ…
   - æˆåŠŸè¯†åˆ«é™„ä»¶å­—æ®µ: **5ä¸ªå›¾ç‰‡å­—æ®µ**
     - Front image(æ­£) - fldRZvGjSK
     - Back image(èƒŒ) - fldhXyI07b  
     - Tag photo(æ ‡ç­¾) - fldGLGCv2m
     - Outer packaging image(å¤–åŒ…è£…) - fldkUCi2Vh
     - Gift pictures(èµ å“å›¾ç‰‡) - fldC0kw9Hh
   - æˆåŠŸæå–æ–‡ä»¶ä»¤ç‰Œ: **47ä¸ªå›¾ç‰‡æ–‡ä»¶ä»¤ç‰Œ**

4. **å›¾ç‰‡æ–‡ä»¶ä¸‹è½½** âœ…
   - æˆåŠŸè·å–ä¸´æ—¶ä¸‹è½½é“¾æ¥
   - æˆåŠŸä¸‹è½½å›¾ç‰‡æ–‡ä»¶: **3ä¸ªæµ‹è¯•æ–‡ä»¶**
   - æ”¯æŒçš„å›¾ç‰‡æ ¼å¼: JPEG, PNG, WebP, GIF
   - æ–‡ä»¶å¤§å°èŒƒå›´: 95KB - 193KB

### ğŸ“Š **è¯¦ç»†æµ‹è¯•æ•°æ®**

#### è¡¨æ ¼å­—æ®µä¿¡æ¯
- æ€»å­—æ®µæ•°: 47ä¸ª
- é™„ä»¶å­—æ®µæ•°: 5ä¸ª
- å…¶ä»–å­—æ®µç±»å‹: æ–‡æœ¬(1)ã€æ•°å­—(2)ã€é€‰æ‹©(3)ã€å¤šé€‰(4)ã€æ—¥æœŸ(1001)ã€å…¬å¼(20)ç­‰

#### è®°å½•æ•°æ®
- æ€»è®°å½•æ•°: 1244æ¡
- æµ‹è¯•è®°å½•æ•°: 20æ¡
- åŒ…å«å›¾ç‰‡çš„è®°å½•: å¤šæ¡è®°å½•åŒ…å«äº§å“å›¾ç‰‡

#### ä¸‹è½½æµ‹è¯•ç»“æœ
æˆåŠŸä¸‹è½½çš„æ–‡ä»¶:
1. `HM-0001A-2-RRbEbxbW3oeH7ZxFlUfcaaV5nnb.jpg` (96.88 KB, JPEG)
2. `HM-0001A-3-X6k9bhZb0oxJoRxxPq4cTbzunRb.jpg` (193.33 KB, JPEG)  
3. `HM-0001A-1-LFAbbt64Ooo0nExpkh2cYMbhn3e.jpg` (95.49 KB, JPEG)

## ğŸ”§ **æŠ€æœ¯å®ç°è¦ç‚¹**

### æ­£ç¡®çš„å›¾ç‰‡ä¸‹è½½æ–¹æ³•

ç»è¿‡è¯¦ç»†æµ‹è¯•ï¼Œæ‰¾åˆ°äº†é£ä¹¦å¤šç»´è¡¨æ ¼å›¾ç‰‡ä¸‹è½½çš„æ­£ç¡®æ–¹æ³•ï¼š

#### 1. å®Œæ•´çš„ä¸‹è½½æµç¨‹

```javascript
// æ­¥éª¤1: è·å–è®¿é—®ä»¤ç‰Œ
POST /open-apis/auth/v3/tenant_access_token/internal
{
  "app_id": "your_app_id",
  "app_secret": "your_app_secret"
}

// æ­¥éª¤2: è·å–è¡¨æ ¼è®°å½•å’Œæ–‡ä»¶ä»¤ç‰Œ
GET /open-apis/bitable/v1/apps/{app_token}/tables/{table_id}/records

// æ­¥éª¤3: è·å–ä¸´æ—¶ä¸‹è½½é“¾æ¥ (å…³é”®æ­¥éª¤)
GET /open-apis/drive/v1/medias/batch_get_tmp_download_url?file_tokens=token1&file_tokens=token2&extra={"bitablePerm":{"tableId":"table_id","rev":15613}}

// æ­¥éª¤4: ä½¿ç”¨ä¸´æ—¶é“¾æ¥ä¸‹è½½æ–‡ä»¶
GET {tmp_download_url}
```

#### 2. æ ¸å¿ƒAPIå‚æ•°è¯¦è§£

**APIç«¯ç‚¹**: `GET /open-apis/drive/v1/medias/batch_get_tmp_download_url`

**å¿…éœ€å‚æ•°**:
- `file_tokens`: æ–‡ä»¶ä»¤ç‰Œæ•°ç»„ï¼Œå¯é‡å¤ä¼ é€’å¤šä¸ª
- `extra`: JSONå­—ç¬¦ä¸²ï¼ŒåŒ…å«æƒé™ä¿¡æ¯
  ```json
  {
    "bitablePerm": {
      "tableId": "tblwdwrZMikMRyxq",
      "rev": 15613
    }
  }
  ```

**è¯·æ±‚å¤´**:
```javascript
{
  "Authorization": "Bearer {tenant_access_token}",
  "Content-Type": "application/json"
}
```

#### 3. å®é™…ä»£ç ç¤ºä¾‹

```javascript
// è·å–ä¸´æ—¶ä¸‹è½½é“¾æ¥
async function getTmpDownloadUrls(fileTokens, tableId) {
  const token = await getAccessToken();

  // æ„å»ºæŸ¥è¯¢å‚æ•°
  const params = new URLSearchParams();
  fileTokens.forEach(token => params.append('file_tokens', token));

  // æ·»åŠ æƒé™å‚æ•°
  const extra = {
    bitablePerm: {
      tableId: tableId,
      rev: 15613  // å¯ä»¥æ˜¯å›ºå®šå€¼æˆ–åŠ¨æ€è·å–
    }
  };
  params.append('extra', JSON.stringify(extra));

  const response = await axios.get(
    `https://open.feishu.cn/open-apis/drive/v1/medias/batch_get_tmp_download_url?${params.toString()}`,
    {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    }
  );

  return response.data.data.tmp_download_urls;
}

// ä¸‹è½½å›¾ç‰‡æ–‡ä»¶
async function downloadImage(tmpDownloadUrl) {
  const response = await axios.get(tmpDownloadUrl, {
    responseType: 'arraybuffer',
    timeout: 60000
  });

  return Buffer.from(response.data);
}
```

### å…³é”®å‘ç°å’Œé™åˆ¶

1. **APIæ–¹å¼é™åˆ¶**:
   - âœ… GETæ–¹å¼: å®Œå…¨æœ‰æ•ˆ
   - âŒ POSTæ–¹å¼: è¿”å›404é”™è¯¯

2. **æ‰¹é‡å¤„ç†é™åˆ¶**:
   - å»ºè®®æ¯æ‰¹å¤„ç† **3-5ä¸ªæ–‡ä»¶ä»¤ç‰Œ**
   - è¶…è¿‡10ä¸ªä»¤ç‰Œå¯èƒ½è¿”å›400é”™è¯¯

3. **æƒé™å‚æ•°å¿…éœ€**:
   - `extra.bitablePerm.tableId` å¿…é¡»åŒ¹é…å®é™…è¡¨æ ¼ID
   - `rev` å‚æ•°å¯ä»¥ä½¿ç”¨å›ºå®šå€¼15613

4. **ä¸´æ—¶é“¾æ¥ç‰¹æ€§**:
   - è¿”å›çš„æ˜¯é£ä¹¦å†…éƒ¨åŸŸåçš„ä¸´æ—¶ä¸‹è½½é“¾æ¥
   - é“¾æ¥æ ¼å¼: `https://internal-api-drive-stream.feishu.cn/space/api/box/stream/download/authcode/?code=...`
   - é“¾æ¥æœ‰æ—¶æ•ˆæ€§ï¼Œå»ºè®®ç«‹å³ä½¿ç”¨

5. **æ–‡ä»¶æ ¼å¼æ”¯æŒ**:
   - âœ… JPEG (.jpg)
   - âœ… PNG (.png)
   - âœ… WebP (.webp)
   - âœ… GIF (.gif)

### é”™è¯¯å¤„ç†å’Œè°ƒè¯•

å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆï¼š

```javascript
// 400é”™è¯¯ - é€šå¸¸æ˜¯å‚æ•°é—®é¢˜
if (error.response?.status === 400) {
  // æ£€æŸ¥file_tokensæ•°é‡æ˜¯å¦è¿‡å¤š
  // æ£€æŸ¥extraå‚æ•°æ ¼å¼æ˜¯å¦æ­£ç¡®
}

// 404é”™è¯¯ - APIç«¯ç‚¹æˆ–æ–¹æ³•é—®é¢˜
if (error.response?.status === 404) {
  // ç¡®ä¿ä½¿ç”¨GETæ–¹å¼è€Œä¸æ˜¯POST
  // æ£€æŸ¥APIç«¯ç‚¹URLæ˜¯å¦æ­£ç¡®
}

// 401é”™è¯¯ - è®¤è¯é—®é¢˜
if (error.response?.status === 401) {
  // æ£€æŸ¥è®¿é—®ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
  // é‡æ–°è·å–tenant_access_token
}
```

## ğŸ“ˆ **æ€§èƒ½è¡¨ç°**

- **è®¤è¯é€Ÿåº¦**: < 1ç§’
- **æ•°æ®è·å–é€Ÿåº¦**: 20æ¡è®°å½• < 2ç§’
- **å›¾ç‰‡ä¸‹è½½é€Ÿåº¦**: å•ä¸ªæ–‡ä»¶ < 5ç§’
- **APIå“åº”ç¨³å®šæ€§**: ä¼˜ç§€
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯ä¿¡æ¯è¿”å›

## ğŸ¯ **æƒé™éªŒè¯ç»“è®º**

### âœ… **å·²éªŒè¯çš„æƒé™**
1. **è¯»å–æƒé™**: å®Œå…¨å…·å¤‡è¡¨æ ¼æ•°æ®è¯»å–æƒé™
2. **å­—æ®µè®¿é—®**: å¯ä»¥è®¿é—®æ‰€æœ‰å­—æ®µç±»å‹å’Œå…ƒæ•°æ®
3. **é™„ä»¶è¯†åˆ«**: å¯ä»¥è¯†åˆ«å’Œè·å–é™„ä»¶æ–‡ä»¶ä¿¡æ¯
4. **æ–‡ä»¶ä¸‹è½½**: å…·å¤‡å›¾ç‰‡æ–‡ä»¶ä¸‹è½½æƒé™

### ğŸ“ **ä½¿ç”¨å»ºè®®**
1. **æ‰¹é‡å¤„ç†**: å»ºè®®æ¯æ‰¹å¤„ç†3-5ä¸ªæ–‡ä»¶ï¼Œé¿å…APIé™åˆ¶
2. **é”™è¯¯é‡è¯•**: å®ç°é€‚å½“çš„é‡è¯•æœºåˆ¶å¤„ç†ç½‘ç»œå¼‚å¸¸
3. **æ–‡ä»¶ç®¡ç†**: ä¸‹è½½çš„æ–‡ä»¶å»ºè®®æŒ‰è®°å½•IDå’Œå­—æ®µåç»„ç»‡å­˜å‚¨
4. **æƒé™ç›‘æ§**: å®šæœŸæ£€æŸ¥è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæ€§

## ï¿½ **ç”Ÿäº§ç¯å¢ƒä»£ç æ¨¡æ¿**

### å®Œæ•´çš„å›¾ç‰‡ä¸‹è½½æœåŠ¡ç±»

```javascript
class FeishuImageDownloader {
  constructor(appId, appSecret, appToken, tableId) {
    this.appId = appId;
    this.appSecret = appSecret;
    this.appToken = appToken;
    this.tableId = tableId;
    this.baseUrl = 'https://open.feishu.cn';
    this.accessToken = null;
    this.tokenExpiry = null;
  }

  // è·å–è®¿é—®ä»¤ç‰Œ
  async getAccessToken() {
    if (this.accessToken && this.tokenExpiry && Date.now() < this.tokenExpiry) {
      return this.accessToken;
    }

    const response = await axios.post(
      `${this.baseUrl}/open-apis/auth/v3/tenant_access_token/internal`,
      {
        app_id: this.appId,
        app_secret: this.appSecret
      }
    );

    if (response.data.code !== 0) {
      throw new Error(`è·å–ä»¤ç‰Œå¤±è´¥: ${response.data.msg}`);
    }

    this.accessToken = response.data.tenant_access_token;
    this.tokenExpiry = Date.now() + (response.data.expire - 300) * 1000; // æå‰5åˆ†é’Ÿè¿‡æœŸ
    return this.accessToken;
  }

  // è·å–è¡¨æ ¼è®°å½•ä¸­çš„å›¾ç‰‡ä»¤ç‰Œ
  async getImageTokensFromTable() {
    const token = await this.getAccessToken();

    const response = await axios.get(
      `${this.baseUrl}/open-apis/bitable/v1/apps/${this.appToken}/tables/${this.tableId}/records`,
      {
        headers: { 'Authorization': `Bearer ${token}` },
        params: { page_size: 500 }
      }
    );

    if (response.data.code !== 0) {
      throw new Error(`è·å–è®°å½•å¤±è´¥: ${response.data.msg}`);
    }

    const imageTokens = [];
    const records = response.data.data?.items || [];

    records.forEach(record => {
      Object.entries(record.fields).forEach(([fieldId, fieldValue]) => {
        if (Array.isArray(fieldValue)) {
          fieldValue.forEach(attachment => {
            if (attachment?.file_token) {
              imageTokens.push({
                recordId: record.record_id,
                fieldId,
                fileToken: attachment.file_token,
                fileName: attachment.name,
                fileSize: attachment.size
              });
            }
          });
        }
      });
    });

    return imageTokens;
  }

  // æ‰¹é‡è·å–ä¸´æ—¶ä¸‹è½½é“¾æ¥
  async getTmpDownloadUrls(fileTokens) {
    const token = await this.getAccessToken();

    // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹æœ€å¤š5ä¸ª
    const batchSize = 5;
    const results = [];

    for (let i = 0; i < fileTokens.length; i += batchSize) {
      const batch = fileTokens.slice(i, i + batchSize);

      const params = new URLSearchParams();
      batch.forEach(token => params.append('file_tokens', token));
      params.append('extra', JSON.stringify({
        bitablePerm: {
          tableId: this.tableId,
          rev: 15613
        }
      }));

      const response = await axios.get(
        `${this.baseUrl}/open-apis/drive/v1/medias/batch_get_tmp_download_url?${params.toString()}`,
        {
          headers: { 'Authorization': `Bearer ${token}` }
        }
      );

      if (response.data.code === 0) {
        results.push(...response.data.data.tmp_download_urls);
      }
    }

    return results;
  }

  // ä¸‹è½½å•ä¸ªå›¾ç‰‡
  async downloadImage(tmpDownloadUrl) {
    const response = await axios.get(tmpDownloadUrl, {
      responseType: 'arraybuffer',
      timeout: 60000
    });

    return Buffer.from(response.data);
  }

  // æ‰¹é‡ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
  async downloadAllImages(outputDir = './downloads') {
    // ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    // è·å–æ‰€æœ‰å›¾ç‰‡ä»¤ç‰Œ
    const imageTokens = await this.getImageTokensFromTable();
    const fileTokens = imageTokens.map(item => item.fileToken);

    // è·å–ä¸‹è½½é“¾æ¥
    const tmpUrls = await this.getTmpDownloadUrls(fileTokens);

    // ä¸‹è½½æ–‡ä»¶
    const results = [];
    for (const urlInfo of tmpUrls) {
      try {
        const buffer = await this.downloadImage(urlInfo.tmp_download_url);
        const tokenInfo = imageTokens.find(item => item.fileToken === urlInfo.file_token);

        // ç”Ÿæˆæ–‡ä»¶å
        const originalName = tokenInfo?.fileName || `file-${urlInfo.file_token}`;
        const ext = path.extname(originalName) || '.jpg';
        const fileName = `${path.parse(originalName).name}-${urlInfo.file_token}${ext}`;
        const filePath = path.join(outputDir, fileName);

        // ä¿å­˜æ–‡ä»¶
        fs.writeFileSync(filePath, buffer);

        results.push({
          success: true,
          fileToken: urlInfo.file_token,
          fileName,
          filePath,
          size: buffer.length
        });

      } catch (error) {
        results.push({
          success: false,
          fileToken: urlInfo.file_token,
          error: error.message
        });
      }
    }

    return results;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const downloader = new FeishuImageDownloader(
  'cli_a8fa1d87c3fad00d',
  'CDfRPlOw8VRQrPyLnpzNvd5wBmu6wROp',
  'J4dFbm5S9azofMsW702cSOVwnsh',
  'tblwdwrZMikMRyxq'
);

// ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
const results = await downloader.downloadAllImages('./feishu-images');
console.log(`æˆåŠŸä¸‹è½½ ${results.filter(r => r.success).length} ä¸ªæ–‡ä»¶`);
```

## ï¿½ğŸ” **æµ‹è¯•è„šæœ¬**

æœ¬æ¬¡æµ‹è¯•åˆ›å»ºäº†ä»¥ä¸‹æµ‹è¯•è„šæœ¬ï¼š
- `test-feishu-permissions.js` - åŸºç¡€æƒé™æµ‹è¯•
- `test-feishu-download-detailed.js` - è¯¦ç»†ä¸‹è½½æ–¹æ³•æµ‹è¯•
- `test-feishu-correct-download.js` - æ­£ç¡®APIæ–¹æ³•æµ‹è¯•
- `test-feishu-final-download.js` - å®Œæ•´ä¸‹è½½æµç¨‹æµ‹è¯•

## ğŸ‰ **æœ€ç»ˆç»“è®º**

**é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®å’Œé™„ä»¶å›¾ç‰‡ä¸‹è½½æƒé™æµ‹è¯•å®Œå…¨æˆåŠŸï¼**

æ‚¨æä¾›çš„é£ä¹¦åº”ç”¨é…ç½®å…·å¤‡å®Œæ•´çš„æ•°æ®è¯»å–å’Œæ–‡ä»¶ä¸‹è½½æƒé™ï¼Œå¯ä»¥ï¼š
- âœ… æ­£å¸¸è®¿é—®è¡¨æ ¼æ•°æ®
- âœ… è·å–æ‰€æœ‰å­—æ®µä¿¡æ¯
- âœ… è¯†åˆ«å’Œä¸‹è½½å›¾ç‰‡é™„ä»¶
- âœ… å¤„ç†å¤šç§å›¾ç‰‡æ ¼å¼
- âœ… ç¨³å®šçš„APIè°ƒç”¨æ€§èƒ½

åº”ç”¨å·²ç»å¯ä»¥ç”¨äºç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åŒæ­¥å’Œå›¾ç‰‡ä¸‹è½½åŠŸèƒ½ã€‚

---

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2025å¹´7æœˆ29æ—¥  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**ä¸‹è½½æ–‡ä»¶ä½ç½®**: `products-b-test/feishu-downloads/`
