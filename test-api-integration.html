<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIé›†æˆæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .loading { background-color: #fff3cd; border-color: #ffeaa7; }
        .product-card { margin: 10px 0; padding: 10px; border: 1px solid #eee; }
        .product-image { max-width: 150px; max-height: 150px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸš€ ç”Ÿäº§æ¨¡å¼APIé›†æˆæµ‹è¯•</h1>
    
    <div id="config-test" class="test-section loading">
        <h3>ğŸ“‹ 1. ç¯å¢ƒé…ç½®æ£€æŸ¥</h3>
        <div id="config-result">æ£€æŸ¥ä¸­...</div>
    </div>
    
    <div id="backend-test" class="test-section loading">
        <h3>ğŸ”§ 2. åç«¯APIè¿æ¥æµ‹è¯•</h3>
        <div id="backend-result">æµ‹è¯•ä¸­...</div>
    </div>
    
    <div id="products-test" class="test-section loading">
        <h3>ğŸ“¦ 3. äº§å“æ•°æ®è·å–æµ‹è¯•</h3>
        <div id="products-result">è·å–ä¸­...</div>
    </div>
    
    <div id="images-test" class="test-section loading">
        <h3>ğŸ–¼ï¸ 4. å›¾ç‰‡èµ„æºè®¿é—®æµ‹è¯•</h3>
        <div id="images-result">æµ‹è¯•ä¸­...</div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const API_BASE_URL = 'http://localhost:3000/api/v1';
        const IMAGE_BASE_URL = 'http://152.89.168.61:9000';
        
        // å·¥å…·å‡½æ•°
        function updateSection(sectionId, content, status = 'success') {
            const section = document.getElementById(sectionId);
            const result = document.getElementById(sectionId.replace('-test', '-result'));
            
            section.className = `test-section ${status}`;
            result.innerHTML = content;
        }
        
        function formatJson(obj) {
            return `<pre>${JSON.stringify(obj, null, 2)}</pre>`;
        }
        
        // 1. ç¯å¢ƒé…ç½®æ£€æŸ¥
        function checkConfig() {
            const config = {
                apiBaseUrl: API_BASE_URL,
                imageBaseUrl: IMAGE_BASE_URL,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            };
            
            updateSection('config-test', 
                `<p>âœ… é…ç½®ä¿¡æ¯åŠ è½½æˆåŠŸ</p>${formatJson(config)}`, 
                'success'
            );
        }
        
        // 2. åç«¯APIè¿æ¥æµ‹è¯•
        async function testBackendConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/../health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    updateSection('backend-test', 
                        `<p>âœ… åç«¯æœåŠ¡è¿æ¥æˆåŠŸ</p>
                         <p>MongoDBçŠ¶æ€: ${data.mongodb}</p>
                         <p>è¿è¡Œæ—¶é—´: ${Math.round(data.uptime)}ç§’</p>
                         ${formatJson(data)}`, 
                        'success'
                    );
                } else {
                    throw new Error('å¥åº·æ£€æŸ¥å¤±è´¥');
                }
            } catch (error) {
                updateSection('backend-test', 
                    `<p>âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥</p>
                     <p>é”™è¯¯: ${error.message}</p>`, 
                    'error'
                );
            }
        }
        
        // 3. äº§å“æ•°æ®è·å–æµ‹è¯•
        async function testProductsAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/products?page=1&limit=3`);
                const data = await response.json();
                
                if (data.success && data.data.products.length > 0) {
                    const products = data.data.products;
                    const productList = products.map(p => 
                        `<div class="product-card">
                            <strong>${p.name}</strong><br>
                            ID: ${p.productId}<br>
                            ä»·æ ¼: Â¥${p.price.normal}<br>
                            åˆ†ç±»: ${p.category.primary} > ${p.category.secondary}<br>
                            å›¾ç‰‡æ•°é‡: ${Object.keys(p.images || {}).length}
                        </div>`
                    ).join('');
                    
                    updateSection('products-test', 
                        `<p>âœ… äº§å“æ•°æ®è·å–æˆåŠŸ</p>
                         <p>è·å–åˆ° ${products.length} ä¸ªäº§å“</p>
                         ${productList}
                         <details>
                            <summary>æŸ¥çœ‹åŸå§‹æ•°æ®</summary>
                            ${formatJson(data)}
                         </details>`, 
                        'success'
                    );
                    
                    // ä¼ é€’äº§å“æ•°æ®ç»™å›¾ç‰‡æµ‹è¯•
                    window.testProducts = products;
                } else {
                    throw new Error('äº§å“æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                updateSection('products-test', 
                    `<p>âŒ äº§å“æ•°æ®è·å–å¤±è´¥</p>
                     <p>é”™è¯¯: ${error.message}</p>`, 
                    'error'
                );
            }
        }
        
        // 4. å›¾ç‰‡èµ„æºè®¿é—®æµ‹è¯•
        async function testImagesAccess() {
            try {
                if (!window.testProducts || window.testProducts.length === 0) {
                    throw new Error('æ²¡æœ‰äº§å“æ•°æ®ç”¨äºæµ‹è¯•');
                }
                
                const product = window.testProducts[0];
                const images = product.images || {};
                
                if (Object.keys(images).length === 0) {
                    throw new Error('äº§å“æ²¡æœ‰å›¾ç‰‡æ•°æ®');
                }
                
                let imageTests = [];
                let successCount = 0;
                
                for (const [type, url] of Object.entries(images)) {
                    if (url) {
                        try {
                            // æµ‹è¯•å›¾ç‰‡æ˜¯å¦å¯è®¿é—®
                            const img = new Image();
                            const loadPromise = new Promise((resolve, reject) => {
                                img.onload = () => resolve(true);
                                img.onerror = () => reject(false);
                                setTimeout(() => reject(false), 5000); // 5ç§’è¶…æ—¶
                            });
                            
                            img.src = url;
                            const loaded = await loadPromise;
                            
                            if (loaded) {
                                successCount++;
                                imageTests.push(`
                                    <div class="product-card">
                                        <strong>${type}å›¾ç‰‡</strong> âœ…<br>
                                        <img src="${url}" class="product-image" alt="${type}"><br>
                                        <small>${url}</small>
                                    </div>
                                `);
                            } else {
                                imageTests.push(`
                                    <div class="product-card">
                                        <strong>${type}å›¾ç‰‡</strong> âŒ<br>
                                        <small>${url}</small><br>
                                        <span style="color: red;">åŠ è½½å¤±è´¥</span>
                                    </div>
                                `);
                            }
                        } catch (error) {
                            imageTests.push(`
                                <div class="product-card">
                                    <strong>${type}å›¾ç‰‡</strong> âŒ<br>
                                    <small>${url}</small><br>
                                    <span style="color: red;">é”™è¯¯: ${error}</span>
                                </div>
                            `);
                        }
                    }
                }
                
                const totalImages = Object.keys(images).length;
                const status = successCount === totalImages ? 'success' : 
                              successCount > 0 ? 'loading' : 'error';
                
                updateSection('images-test', 
                    `<p>${successCount === totalImages ? 'âœ…' : 'âš ï¸'} å›¾ç‰‡è®¿é—®æµ‹è¯•å®Œæˆ</p>
                     <p>æˆåŠŸ: ${successCount}/${totalImages}</p>
                     <p>äº§å“: ${product.name}</p>
                     ${imageTests.join('')}`, 
                    status
                );
                
            } catch (error) {
                updateSection('images-test', 
                    `<p>âŒ å›¾ç‰‡è®¿é—®æµ‹è¯•å¤±è´¥</p>
                     <p>é”™è¯¯: ${error.message}</p>`, 
                    'error'
                );
            }
        }
        
        // æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            console.log('ğŸš€ å¼€å§‹APIé›†æˆæµ‹è¯•...');
            
            // 1. é…ç½®æ£€æŸ¥
            checkConfig();
            
            // 2. åç«¯è¿æ¥æµ‹è¯•
            await testBackendConnection();
            
            // 3. äº§å“æ•°æ®æµ‹è¯•
            await testProductsAPI();
            
            // 4. å›¾ç‰‡è®¿é—®æµ‹è¯•
            await testImagesAccess();
            
            console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>
